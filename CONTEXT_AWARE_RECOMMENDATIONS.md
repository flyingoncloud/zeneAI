# Context-Aware Module Recommendations - Smart Gating System

## é—®é¢˜åˆ†æ

### ä¹‹å‰çš„é—®é¢˜

1. **è¿‡æ—©æ¨è** - ä»…å‡­"ä½ å¥½"å°±æ¨èæƒ…ç»ªå‘½åï¼ˆå› ä¸º vague_emotional_expressionï¼‰
2. **å¼ºåˆ¶æ¨è** - æ¯æ¬¡æ£€æµ‹åˆ°è§¦å‘å°±æ¨èï¼Œä¸è€ƒè™‘æ˜¯å¦åˆé€‚
3. **ç¼ºä¹ä¸Šä¸‹æ–‡** - ç¬¬ä¸€æ¡æ¶ˆæ¯çš„å¿ƒç†çŠ¶æ€åˆ†ææ²¡æœ‰æ„ä¹‰
4. **æ˜¾ç¤ºè¿‡åº¦** - HTMLç•Œé¢æ¯æ¬¡éƒ½æ˜¾ç¤ºæ¨èæ¨¡å—

### ç”¨æˆ·å»ºè®®

> "Do you think it will be a better idea to recommend the modules based on keywords or, more accurately, the conversational context of the past conversational history (e.g. past 10 messages), and recommend one module when the chatbot thinks it is appropriate and natural to do so?"

**æ ¸å¿ƒæ€æƒ³**:
- åŸºäºå¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆè¿‡å»10æ¡æ¶ˆæ¯ï¼‰åˆ¤æ–­
- ä½¿ç”¨å…³é”®è¯æ£€æµ‹çœŸå®çš„æƒ…ç»ªå›°æ‰°
- è®© GPT è‡ªç„¶å†³å®šä½•æ—¶æ¨èï¼Œè€Œä¸æ˜¯å¼ºåˆ¶æ¨è

---

## è§£å†³æ–¹æ¡ˆï¼šä¸‰é‡é—¨æ§ç³»ç»Ÿ

### é—¨æ§æœºåˆ¶ (Three-Gate System)

```python
def _should_recommend_modules():
    # Gate 1: æœ€å°‘æ¶ˆæ¯æ•°é‡è¦æ±‚
    if user_messages < 2:
        return False  # è¿‡æ»¤é—®å€™è¯­ã€ç¬¬ä¸€æ¡æ¶ˆæ¯

    # Gate 2: æƒ…ç»ªå›°æ‰°å…³é”®è¯æ£€æµ‹
    if not has_distress_keywords_in_recent_10_messages:
        return False  # è¿‡æ»¤é—²èŠã€æ™®é€šå¯¹è¯

    # Gate 3: å¿ƒç†çŠ¶æ€æŒ‡æ ‡éªŒè¯
    if not any_strong_psychological_indicator:
        return False  # ç¡®ä¿æœ‰çœŸå®éœ€æ±‚

    return True  # æ‰€æœ‰é—¨æ§é€šè¿‡ï¼Œå¯ä»¥æ¨è
```

### Gate 1: æœ€å°‘æ¶ˆæ¯æ•°é‡ï¼ˆMinimum Message Thresholdï¼‰

**è§„åˆ™**: è‡³å°‘éœ€è¦ 2 æ¡ç”¨æˆ·æ¶ˆæ¯ï¼ˆä¸å«å½“å‰æ¶ˆæ¯ï¼‰

**åŸå› **:
- è¿‡æ»¤é—®å€™è¯­ï¼š"ä½ å¥½"ã€"Hi"ã€"åœ¨å—"
- è¿‡æ»¤ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œå³ä½¿åŒ…å«æƒ…ç»ªè¯
- éœ€è¦å»ºç«‹å¯¹è¯ä¸Šä¸‹æ–‡æ‰èƒ½å‡†ç¡®åˆ†æ

**ç¤ºä¾‹**:
```
âŒ ç”¨æˆ·: "ä½ å¥½" â†’ ä¸æ¨èï¼ˆåªæœ‰1æ¡æ¶ˆæ¯ï¼‰
âŒ ç”¨æˆ·: "æˆ‘å¥½ç—›è‹¦" (ç¬¬ä¸€æ¡) â†’ ä¸æ¨èï¼ˆéœ€è¦æ›´å¤šä¸Šä¸‹æ–‡ï¼‰
âœ… ç”¨æˆ·: "æˆ‘å¥½ç—›è‹¦" (ç¬¬ä¸‰æ¡) â†’ å¯èƒ½æ¨èï¼ˆæœ‰ä¸Šä¸‹æ–‡ï¼‰
```

### Gate 2: æƒ…ç»ªå›°æ‰°å…³é”®è¯ï¼ˆDistress Keywords Detectionï¼‰

**è§„åˆ™**: åœ¨æœ€è¿‘10æ¡ç”¨æˆ·æ¶ˆæ¯ä¸­ï¼Œå¿…é¡»åŒ…å«è‡³å°‘1ä¸ªæƒ…ç»ªå›°æ‰°å…³é”®è¯

**å…³é”®è¯åˆ—è¡¨** (Chinese):
```python
ç„¦è™‘, ææ…Œ, æ„¤æ€’, å´©æºƒ, å¤±æ§, å—ä¸äº†, è¦ç‚¸äº†, è¦ç–¯äº†,
å¿ƒè·³åŠ é€Ÿ, å¿ƒè·³å¾ˆå¿«, å–˜ä¸è¿‡æ°”, çª’æ¯, å‘æŠ–, æ§åˆ¶ä¸ä½,
ç—›è‹¦, ç»æœ›, æ— åŠ©, å­¤ç‹¬, ç©ºè™š, è¿·èŒ«, å›°æƒ‘, çº ç»“,
å‹åŠ›å±±å¤§, ç»·ä¸ä½, éš¾å—, ç…ç†¬, æŠ˜ç£¨, å®³æ€•, ææƒ§,
æ‹…å¿ƒ, ç´§å¼ , ä¸å®‰, çƒ¦èº, éƒé—·, æŠ‘éƒ
```

**åŸå› **:
- è¿‡æ»¤é—²èŠï¼š"ä»Šå¤©å¤©æ°”ä¸é”™"ã€"åƒé¥­äº†å—"
- ç¡®ä¿æœ‰çœŸå®çš„æƒ…ç»ªå›°æ‰°è¡¨è¾¾
- åŸºäºè¿‡å»10æ¡æ¶ˆæ¯ï¼Œè€ƒè™‘å¯¹è¯å†å²

**ç¤ºä¾‹**:
```
âŒ "ä»Šå¤©å¤©æ°”ä¸é”™" â†’ æ— å…³é”®è¯ï¼Œä¸æ¨è
âŒ "å·¥ä½œæœ‰ç‚¹å¿™" â†’ æ— å…³é”®è¯ï¼Œä¸æ¨è
âœ… "å·¥ä½œå‹åŠ›å¤ªå¤§ï¼Œç„¦è™‘å¾—å—ä¸äº†" â†’ æœ‰å…³é”®è¯ï¼Œé€šè¿‡Gate 2
```

### Gate 3: å¿ƒç†çŠ¶æ€æŒ‡æ ‡ï¼ˆPsychological Indicatorsï¼‰

**è§„åˆ™**: è‡³å°‘æœ‰ä¸€ä¸ªå¼ºæŒ‡æ ‡è¢«è§¦å‘

**å¼ºæŒ‡æ ‡**:
- `high_intensity` - é«˜æƒ…ç»ªå¼ºåº¦ (â‰¥0.7)
- `vague_expression` - æ¨¡ç³Šè¡¨è¾¾ (clarity <0.4)
- `symbolic_language` - è±¡å¾æ€§è¯­è¨€ (complexity â‰¥0.6)
- `self_exploration` - è‡ªæˆ‘æ¢ç´¢ (awareness â‰¥0.6)

**åŸå› **:
- å³ä½¿æœ‰æƒ…ç»ªè¯ï¼Œä¹Ÿéœ€è¦ç¡®è®¤çœŸå®éœ€æ±‚
- é˜²æ­¢è½»å¾®æƒ…ç»ªæ³¢åŠ¨å°±æ¨è
- ä¸ Gate 2 é…åˆï¼ŒåŒé‡éªŒè¯

**ç¤ºä¾‹**:
```
âŒ "æœ‰ç‚¹å°ç„¦è™‘" â†’ intensity=0.4ï¼Œæ— å¼ºæŒ‡æ ‡
âœ… "ç„¦è™‘å¾—è¦ç–¯äº†" â†’ intensity=0.9ï¼Œè§¦å‘high_intensity
```

---

## å®ç°ç»†èŠ‚

### 1. ä»£ç ä¿®æ”¹ - `src/modules/recommender.py`

#### æ·»åŠ æƒ…ç»ªå›°æ‰°å…³é”®è¯åº“
```python
class ModuleRecommender:
    DISTRESS_KEYWORDS_ZH = [
        "ç„¦è™‘", "ææ…Œ", "æ„¤æ€’", "å´©æºƒ", "å¤±æ§", ...
    ]
```

#### æ·»åŠ é—¨æ§æ£€æŸ¥æ–¹æ³•
```python
def _should_recommend_modules(
    self,
    current_message: str,
    conversation_history: List[Dict[str, str]],
    psychological_state: Dict,
    language: str
) -> bool:
    # Gate 1: Minimum 2 user messages
    user_messages = [msg for msg in conversation_history if msg["role"] == "user"]
    if len(user_messages) < 2:
        return False

    # Gate 2: Check distress keywords in recent 10 messages
    recent_messages = conversation_history[-10:]
    recent_user_messages = [msg["content"] for msg in recent_messages if msg["role"] == "user"]
    recent_user_messages.append(current_message)

    keywords = self.DISTRESS_KEYWORDS_ZH if language == "zh" else self.DISTRESS_KEYWORDS_EN
    has_distress_keywords = any(
        any(keyword in msg.lower() for keyword in keywords)
        for msg in recent_user_messages
    )
    if not has_distress_keywords:
        return False

    # Gate 3: Check strong psychological indicators
    indicators = psychological_state.get("indicators", {})
    strong_indicators = [
        indicators.get("high_intensity", False),
        indicators.get("vague_expression", False),
        indicators.get("symbolic_language", False),
        indicators.get("self_exploration", False)
    ]
    if not any(strong_indicators):
        return False

    return True  # All gates passed
```

#### åœ¨ `get_recommendations()` ä¸­åº”ç”¨é—¨æ§
```python
def get_recommendations(...):
    # Step 1: Analyze psychological state
    psychological_state = self.analyzer.analyze_with_context(...)

    # Step 1.5: Context-aware gating âœ¨ NEW
    should_recommend = self._should_recommend_modules(
        current_message, conversation_history,
        psychological_state, language
    )

    if not should_recommend:
        return {
            "has_recommendations": False,
            "recommendations": [],
            ...
        }

    # Step 2: Continue with trigger detection...
```

### 2. æç¤ºè¯ä¼˜åŒ– - æ›´æŸ”å’Œçš„å»ºè®®

**ä¹‹å‰** (å¼ºåˆ¶æ€§):
```
ä½ å¯ä»¥è€ƒè™‘åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æåˆ°ã€Œå‘¼å¸è®­ç»ƒã€è¿™ä¸ªæ¨¡å—ã€‚
å‚è€ƒå¼•å¯¼è¯­ï¼š...
è®°ä½ï¼šåƒæœ‹å‹èŠå¤©ä¸€æ ·è‡ªç„¶æå‡º
```

**ç°åœ¨** (å¯é€‰æ€§):
```
ğŸ’¡ **å¯é€‰å»ºè®®**ï¼ˆä¸æ˜¯å¿…é¡»ï¼‰ï¼š
æ ¹æ®ç”¨æˆ·å½“å‰çš„çŠ¶æ€ï¼Œã€Œå‘¼å¸è®­ç»ƒã€å¯èƒ½æœ‰å¸®åŠ©ã€‚
å‚è€ƒå¼•å¯¼è¯­ï¼š...

**é‡è¦æé†’**ï¼š
- è¿™åªæ˜¯**å¯é€‰çš„å»ºè®®**ï¼Œä¸æ˜¯å¿…é¡»è¦æçš„
- **åªåœ¨è‡ªç„¶ã€åˆé€‚çš„æ—¶å€™æåŠ**ï¼Œä¸è¦ä¸ºäº†æ¨èè€Œæ¨è
- å¦‚æœå½“ä¸‹å€¾å¬å’Œå…±æƒ…æ›´é‡è¦ï¼Œå°±ä¸“æ³¨äºæ­¤ï¼Œå®Œå…¨å¯ä»¥ä¸ææ¨¡å—
- ç”¨æˆ·ä½“éªŒæœ€é‡è¦ï¼Œä¸è¦è®©å¯¹è¯å˜å¾—ç”Ÿç¡¬
```

---

## æµ‹è¯•éªŒè¯

### Test Suite: `test_context_aware_gating.sh`

#### æµ‹è¯• 1: é—®å€™è¯­ âœ…
```
è¾“å…¥: "ä½ å¥½"
æœŸæœ›: ä¸æ¨èï¼ˆåªæœ‰1æ¡æ¶ˆæ¯ï¼‰
ç»“æœ: âœ… æ­£ç¡®ï¼šæ²¡æœ‰æ¨èï¼ˆé—¨æ§ç”Ÿæ•ˆï¼‰
AIå›åº”: "ä½ å¥½å‘€ï¼æœ‰ä»€ä¹ˆå›°æ‰°æˆ–è€…æƒ³è¯´çš„äº‹æƒ…å¯ä»¥å’Œæˆ‘åˆ†äº«å—ï¼Ÿ"
```

#### æµ‹è¯• 2: é—²èŠ âœ…
```
è¾“å…¥: "ä»Šå¤©å¤©æ°”ä¸é”™"
æœŸæœ›: ä¸æ¨èï¼ˆæ— æƒ…ç»ªå…³é”®è¯ï¼‰
ç»“æœ: âœ… æ­£ç¡®ï¼šæ²¡æœ‰æ¨èï¼ˆæ— æƒ…ç»ªå›°æ‰°å…³é”®è¯ï¼‰
AIå›åº”: "æ˜¯å‘€ï¼Œå¥½å¤©æ°”æ€»èƒ½å¸¦æ¥å¥½å¿ƒæƒ…ï¼..."
```

#### æµ‹è¯• 3: æœ‰ä¸Šä¸‹æ–‡çš„æƒ…ç»ªå›°æ‰° âœ…
```
å¯¹è¯å†å²:
- ç”¨æˆ·: "ä½ å¥½"
- åŠ©æ‰‹: "ä½ å¥½å‘€ï¼..."
- ç”¨æˆ·: "ä»Šå¤©å¤©æ°”ä¸é”™"
- åŠ©æ‰‹: "æ˜¯å‘€..."
- ç”¨æˆ·: "æˆ‘çœŸçš„å¥½ç„¦è™‘ï¼Œå¿ƒè·³å¾ˆå¿«ï¼Œå—ä¸äº†äº†" â† ç¬¬3æ¡

æœŸæœ›: æ¨èï¼ˆ3æ¡æ¶ˆæ¯ + æœ‰å…³é”®è¯ + é«˜å¼ºåº¦æŒ‡æ ‡ï¼‰
ç»“æœ: âœ… æ­£ç¡®ï¼šæ¨èäº†å‘¼å¸è®­ç»ƒï¼ˆè¯„åˆ†: 0.90ï¼‰
AIå›åº”: "å¬èµ·æ¥ä½ ç°åœ¨æ„Ÿè§‰å¾ˆä¸èˆ’æœ...å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥è¯•è¯•é—­ä¸Šçœ¼ç›..."
```

#### æµ‹è¯• 4: ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå³ä½¿æœ‰å›°æ‰°è¯ï¼‰âœ…
```
è¾“å…¥: "æˆ‘å¥½ç—›è‹¦å•Š" (æ–°ä¼šè¯ç¬¬ä¸€æ¡)
æœŸæœ›: ä¸æ¨èï¼ˆéœ€è¦æ›´å¤šä¸Šä¸‹æ–‡ï¼‰
ç»“æœ: âœ… æ­£ç¡®ï¼šæ²¡æœ‰æ¨èï¼ˆéœ€è¦æ›´å¤šå¯¹è¯å»ºç«‹ä¸Šä¸‹æ–‡ï¼‰
AIå›åº”: "åˆ«éš¾è¿‡ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…å—ï¼Ÿ"
```

---

## æ•ˆæœå¯¹æ¯”

### åœºæ™¯ 1: é—®å€™è¯­

| ç»´åº¦ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| æ¨èç»“æœ | âŒ æ¨èæƒ…ç»ªå‘½å (vague) | âœ… ä¸æ¨è |
| AIå›åº” | åŒ…å«æ¨¡å—å¼•å¯¼ | çº¯é—®å€™ |
| ç”¨æˆ·ä½“éªŒ | ç”Ÿç¡¬ã€ä¸è‡ªç„¶ | è‡ªç„¶ã€äº²åˆ‡ |

### åœºæ™¯ 2: é—²èŠ

| ç»´åº¦ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| æ¨èç»“æœ | âŒ å¯èƒ½æ¨è | âœ… ä¸æ¨è |
| AIå›åº” | å¯èƒ½æåŠæ¨¡å— | æ­£å¸¸èŠå¤© |
| ç”¨æˆ·ä½“éªŒ | åƒæ¨é”€ | åƒæœ‹å‹ |

### åœºæ™¯ 3: çœŸå®æƒ…ç»ªå›°æ‰°

| ç»´åº¦ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| æ¨èç»“æœ | âœ… æ¨è | âœ… æ¨è |
| AIå›åº” | åŒ…å«æ¨¡å— | åŒ…å«æ¨¡å—ï¼ˆæ›´è‡ªç„¶ï¼‰|
| ç”¨æˆ·ä½“éªŒ | å¯èƒ½ç”Ÿç¡¬ | è‡ªç„¶èå…¥ |

---

## å…³é”®æ”¹è¿›

### 1. æ™ºèƒ½é—¨æ§ (Smart Gating)
- âœ… åŸºäºå¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆè¿‡å»10æ¡æ¶ˆæ¯ï¼‰
- âœ… å…³é”®è¯æ£€æµ‹çœŸå®æƒ…ç»ªå›°æ‰°
- âœ… ä¸‰é‡éªŒè¯ç¡®ä¿æ¨èå‡†ç¡®æ€§

### 2. è‡ªç„¶æ¨è (Natural Suggestions)
- âœ… GPT å†³å®šä½•æ—¶æåŠï¼Œä¸å¼ºåˆ¶
- âœ… "å¯é€‰å»ºè®®"è€Œé"å¿…é¡»æ¨è"
- âœ… ç”¨æˆ·ä½“éªŒä¼˜å…ˆ

### 3. ä¸Šä¸‹æ–‡æ„ŸçŸ¥ (Context-Aware)
- âœ… æœ€å°‘2æ¡æ¶ˆæ¯å»ºç«‹åŸºçº¿
- âœ… è€ƒè™‘å¯¹è¯å†å²ï¼ˆ10æ¡æ¶ˆæ¯çª—å£ï¼‰
- âœ… é¿å…è¿‡æ—©ã€ä¸å½“æ¨è

---

## è®¾è®¡åŸåˆ™

### 1. å®ç¼ºæ¯‹æ»¥ (Better Safe Than Sorry)
- ä¸ç¡®å®šæ—¶ä¸æ¨è
- éœ€è¦çœŸå®çš„æƒ…ç»ªå›°æ‰°ä¿¡å·
- ä¿æŠ¤ç”¨æˆ·ä½“éªŒ

### 2. ä¸Šä¸‹æ–‡è‡³ä¸Š (Context First)
- ä¸ä»å•æ¡æ¶ˆæ¯åˆ¤æ–­
- è€ƒè™‘å¯¹è¯å†å²å’Œè¿›å±•
- ç­‰å¾…åˆé€‚æ—¶æœº

### 3. è‡ªç„¶æµç•… (Natural Flow)
- æ¨èæ˜¯å¯¹è¯çš„ä¸€éƒ¨åˆ†ï¼Œä¸æ˜¯æ‰“æ–­
- GPT æœ‰æƒä¸æï¼ˆå¦‚æœä¸è‡ªç„¶ï¼‰
- å€¾å¬å’Œå…±æƒ…æ°¸è¿œä¼˜å…ˆ

---

## æŠ€æœ¯æ¶æ„

```
ç”¨æˆ·æ¶ˆæ¯
    â†“
[å¿ƒç†çŠ¶æ€åˆ†æ]
    â†“
[ä¸‰é‡é—¨æ§æ£€æŸ¥] â† âœ¨ NEW
    â”œâ”€ Gate 1: æœ€å°‘2æ¡ç”¨æˆ·æ¶ˆæ¯
    â”œâ”€ Gate 2: æƒ…ç»ªå›°æ‰°å…³é”®è¯ï¼ˆè¿‡å»10æ¡ï¼‰
    â””â”€ Gate 3: å¼ºå¿ƒç†æŒ‡æ ‡éªŒè¯
    â†“
é—¨æ§ä¸é€šè¿‡ â†’ è¿”å›ç©ºæ¨èåˆ—è¡¨
    â†“
é—¨æ§é€šè¿‡ â†’ [è§¦å‘æ£€æµ‹] â†’ [æ¨èç”Ÿæˆ]
    â†“
[å¯é€‰å»ºè®®æç¤º] (ä¸å¼ºåˆ¶)
    â†“
[GPT è‡ªç„¶å†³å®š] æ˜¯å¦æåŠ
    â†“
AI å›åº”
```

---

## ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œæµ‹è¯•
```bash
./test_context_aware_gating.sh
```

### 2. æ‰“å¼€Webç•Œé¢
```bash
open test_chat_interface.html
```

### 3. éªŒè¯è¡Œä¸º
- å‘é€"ä½ å¥½" â†’ åº”è¯¥ä¸æ¨è
- é—²èŠå‡ å¥ â†’ åº”è¯¥ä¸æ¨è
- è¡¨è¾¾çœŸå®å›°æ‰°ï¼ˆç¬¬3æ¡èµ·ï¼‰â†’ åº”è¯¥æ¨è

---

## æœªæ¥ä¼˜åŒ–

### å¯èƒ½çš„æ”¹è¿›æ–¹å‘

1. **åŠ¨æ€é˜ˆå€¼è°ƒæ•´**
   - æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´é—¨æ§é˜ˆå€¼
   - å­¦ä¹ ç”¨æˆ·åå¥½

2. **æ›´ç²¾ç»†çš„å…³é”®è¯æ£€æµ‹**
   - ä½¿ç”¨è¯å‘é‡ç›¸ä¼¼åº¦
   - è€ƒè™‘å¦å®šè¯ï¼ˆ"ä¸ç„¦è™‘"ï¼‰

3. **å¯¹è¯æ„å›¾è¯†åˆ«**
   - è¯†åˆ«æ±‚åŠ© vs åˆ†äº«
   - åŒºåˆ†å€¾è¯‰éœ€æ±‚ vs è§£å†³æ–¹æ¡ˆéœ€æ±‚

4. **æ¨èæ—¶æœºä¼˜åŒ–**
   - ä¸åœ¨å¯¹è¯é«˜æ½®æ—¶æ‰“æ–­
   - ç­‰å¾…è‡ªç„¶åœé¡¿ç‚¹

---

**æ›´æ–°æ—¥æœŸ**: 2026-01-12
**ç‰ˆæœ¬**: 4.0.0 (Context-Aware Recommendations)

**æ ¸å¿ƒä»·å€¼**:
> "æ¨èä¸æ˜¯ä»»åŠ¡ï¼Œè€Œæ˜¯å¯¹è¯ä¸­è‡ªç„¶æ¶Œç°çš„å¯èƒ½æ€§ã€‚åªåœ¨çœŸæ­£éœ€è¦ã€çœŸæ­£åˆé€‚çš„æ—¶å€™ï¼Œè½»è½»æä¸€å¥ã€‚"
